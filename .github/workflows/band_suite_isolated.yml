name: band-suite (isolated)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"

concurrency:
  group: band-suite-${{ github.ref }}
  cancel-in-progress: true

jobs:
  band_suite:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Prepare _ci_out early
        run: |
          mkdir -p _ci_out
          echo "init" > _ci_out/_keep.txt

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r dd_coherence_tool/requirements.txt
          pip install pytest

      - name: Run band suite entrypoint (with logs)
        run: |
          set -euo pipefail
          python scripts/ci_band_suite.py

      - name: List _ci_out (debug)
        if: always()
        run: |
          echo "Files in _ci_out:"
          find _ci_out -maxdepth 3 -type f -print | sort || true
          echo "Sanity:"
          cat _ci_out/sanity.txt || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: band_suite_artifacts
          path: _ci_out
